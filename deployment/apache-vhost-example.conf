# Example Apache Virtual Host Configuration for Wikistr
# This file shows the complete configuration including OG Proxy and AsciiDoctor
# 
# To use this:
# 1. Replace YOUR_SERVER_IP with your actual server IP (e.g., 217.154.126.125)
# 2. Replace yourdomain.com with your actual domain (e.g., wikistr.imwald.eu)
# 3. Replace the port 3000 with the port for your theme (3000=wikistr, 4000=biblestr, etc.)
# 4. Copy the relevant sections to your Let's Encrypt SSL configuration file:
#    /etc/apache2/sites-available/yourdomain.com-le-ssl.conf

# HTTP to HTTPS Redirect (usually in yourdomain.com.conf)
<VirtualHost YOUR_SERVER_IP:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://yourdomain.com/
</VirtualHost>

# HTTPS Virtual Host (in yourdomain.com-le-ssl.conf)
<IfModule mod_ssl.c>
<VirtualHost YOUR_SERVER_IP:443>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com

    # Reverse Proxy Configuration
    ProxyPreserveHost On
    
    # IMPORTANT: These ProxyPass directives MUST come BEFORE the main ProxyPass /
    # Otherwise they won't work correctly!
    
    # OG Proxy for BibleGateway previews and OpenGraph metadata
    # This proxies requests from https://yourdomain.com/sites/* to http://127.0.0.1:8090/sites/*
    ProxyPass /sites/ http://127.0.0.1:8090/sites/
    ProxyPassReverse /sites/ http://127.0.0.1:8090/sites/
    
    # AsciiDoctor server for PDF/EPUB conversion
    # This proxies requests from https://yourdomain.com/asciidoctor/* to http://127.0.0.1:8091/*
    ProxyPass /asciidoctor/ http://127.0.0.1:8091/
    ProxyPassReverse /asciidoctor/ http://127.0.0.1:8091/
    
    # Main application proxy (MUST come last)
    # Change port 3000 to match your theme:
    #   - 3000 = wikistr
    #   - 4000 = biblestr
    #   - 4050 = quranstr
    #   - 4080 = torahstr
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/

    # Headers for proper proxying (IMPORTANT: use https and 443 for HTTPS)
    Header always set X-Forwarded-Proto https
    Header always set X-Forwarded-Port 443

    # SSL Configuration (configured by Let's Encrypt certbot)
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/yourdomain.com/privkey.pem
    
    # Logging (optional)
    ErrorLog ${APACHE_LOG_DIR}/yourdomain-error.log
    CustomLog ${APACHE_LOG_DIR}/yourdomain-access.log combined
</VirtualHost>
</IfModule>

# Notes:
# - The order of ProxyPass directives is critical: /sites/ and /asciidoctor/ must come before /
# - All services (main app, OG Proxy, AsciiDoctor) run on localhost and are not exposed externally
# - OG Proxy runs on port 8090
# - AsciiDoctor runs on port 8091
# - Main application runs on port 3000 (wikistr), 4000 (biblestr), 4050 (quranstr), or 4080 (torahstr)

